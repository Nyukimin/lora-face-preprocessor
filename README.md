# lora-face-preprocessor

LoRA学習用の顔画像を自動的に前処理するツールです。

## プロジェクト概要

### 目的
- `input/`フォルダに混在している画像（全身〜顔寄り）を自動的に仕分け
- 顔検出できた画像から1024x1024の顔中心クロップを作成
- 誤検出（false positive）を減らすための検証機能を実装

### 主な機能
1. **自動画像分類**: 顔の大きさに応じてA_fullbody/B_upper/C_closeupに自動分類
2. **顔検出**: OpenCVのHaar Cascadeを使用した顔検出（正面・横顔対応）
3. **誤検出対策**: 目検証、顔占有率チェックによる誤検出の削減
4. **クロップ生成**: 顔中心の1024x1024正方形クロップを自動生成
5. **レポート生成**: 処理結果をCSV形式で出力

### 出力フォルダ構成
```
out/
├── A_fullbody/    # 顔が小さい（または検出できない）画像
├── B_upper/       # 上半身想定の画像
├── C_closeup/     # 顔寄り想定の画像
├── cropped_1024/  # 1024x1024にクロップした学習候補
└── report.csv     # 処理結果の詳細レポート
```

## セットアップ

### 必要な環境
- Python 3.10以上
- OpenCV (opencv-python)
- NumPy
- Pillow

### インストール

```bash
# 依存パッケージのインストール
pip install -r requirements.txt
```

## 使い方

### 1. split_crop_faces.py - メイン処理スクリプト

顔検出と画像分類、クロップ生成を行うメインスクリプトです。

#### 基本的な使い方

```bash
python split_crop_faces.py
```

#### 処理フロー
1. `input/`フォルダから画像を読み込み
2. 顔検出（正面・横顔・反転横顔）
3. 目検証による誤検出チェック
4. 顔占有率による小さな顔のリジェクト
5. A/B/Cへの自動分類
6. 1024x1024クロップの生成（B/Cのみ、設定次第）
7. `out/report.csv`への結果出力

#### 主要パラメータ（`split_crop_faces.py`内で設定）

| パラメータ | デフォルト | 説明 |
|-----------|----------|------|
| `MIN_FACE_SIZE` | 30 | 顔検出の最小サイズ（小さいほど検出率↑、誤検出↑） |
| `MIN_NEIGHBORS_FACE` | 3 | 検出の厳しさ（小さいほど検出率↑、誤検出↑） |
| `MIN_FACE_AREA_RATIO` | 0.05 | 顔占有率の最小値（小さいほど全身も拾う） |
| `REQUIRE_EYES` | True | 目検証を必須にするか（Falseで横顔も拾う） |
| `MIN_EYES` | 1 | 必要な目の数（1=横顔OK、2=正面のみ） |
| `CROP_SCALE` | 1.6 | クロップの余白（小さいほど髪・背景が少ない） |
| `CROP_ONLY_FOR_BC` | True | A_fullbodyをクロップから除外（髪型学習を避ける） |

#### 出力例
```
Done.
- Images processed : 91
- No face detected : 30
- Rejected small   : 19
- Crop failed      : 0
- Output folder    : E:\...\out
- Report CSV       : E:\...\out\report.csv
- Cropped dataset  : E:\...\out\cropped_1024
```

#### パラメータ調整のヒント
- **検出率が低い場合**: `MIN_FACE_SIZE=25`、`MIN_NEIGHBORS_FACE=2`、`REQUIRE_EYES=False`
- **リジェクトが多い場合**: `MIN_FACE_AREA_RATIO=0.05`（より小さな値）
- **髪型を学習させたくない場合**: `CROP_SCALE=1.4`、`CROP_ONLY_FOR_BC=True`

---

### 2. tools/analyze_report.py - 基本統計分析

`report.csv`を分析して基本的な統計情報を表示します。

#### 使い方

```bash
python tools/analyze_report.py
```

#### 出力内容
- 総画像数
- 顔検出率
- 検出なしの数
- 正常処理（保存）数
- リジェクト数
- 顔サイズ統計（平均・最小・最大）
- 分類別統計（A/B/C）
- 目検出統計
- 改善提案

#### 実行例
```
============================================================
[統計] 処理結果
============================================================
総画像数: 91

【検出結果】
  顔検出: 61 (67.0%)
  検出なし: 30 (33.0%)

【処理結果】
  正常処理（保存）: 42 (46.2%)
  小さな顔でリジェクト: 19 (20.9%)

【顔サイズ統計】
  平均顔比率: 0.1595
  最小: 0.0053
  最大: 0.6275
...
```

---

### 3. tools/analyze_report_detailed.py - 詳細分析

`report.csv`を詳細に分析し、問題のある画像を特定します。

#### 使い方

```bash
python tools/analyze_report_detailed.py
```

#### 出力内容
- 基本統計（検出率、保存率、リジェクト率）
- 検出器別統計（frontal/profile/profile_flip）
- 分類別統計（A_fullbody/B_upper/C_closeup）
- **顔検出されなかった画像のリスト**（最大20件）
- **小さな顔でリジェクトされた画像のリスト**（最大20件、顔比率順）
- 正常に保存された画像の統計
- 改善提案（問題がある場合）

#### 実行例
```
======================================================================
詳細分析レポート
======================================================================

総画像数: 91
顔検出: 61 (67.0%)
検出なし: 30 (33.0%)
保存済み: 42 (46.2%)
リジェクト: 19 (20.9%)

======================================================================
検出器別統計
======================================================================
  frontal: 37件
  profile: 21件
  profile_flip: 3件

======================================================================
顔検出されなかった画像 (30件)
======================================================================
   1. スクリーンショット 2024-11-06 8.48.24.png (840x638)
   2. スクリーンショット 2024-11-06 8.48.47.png (250x240)
   ...
```

#### 活用方法
- **問題画像の特定**: 検出されなかった画像やリジェクトされた画像を確認
- **パラメータ調整の判断**: 改善提案に基づいて`split_crop_faces.py`のパラメータを調整
- **品質管理**: 保存された画像の統計から学習データの品質を確認

---

## ワークフロー例

### 基本的な使用フロー

1. **画像を配置**
   ```bash
   # input/フォルダに画像を配置
   ```

2. **処理実行**
   ```bash
   python split_crop_faces.py
   ```

3. **結果確認**
   ```bash
   # 基本統計を確認
   python tools/analyze_report.py
   
   # 詳細分析で問題画像を確認
   python tools/analyze_report_detailed.py
   ```

4. **パラメータ調整（必要に応じて）**
   - `split_crop_faces.py`のパラメータを調整
   - 再実行して結果を比較

5. **学習データの確認**
   - `out/cropped_1024/`フォルダの画像を確認
   - 必要に応じて手動でフィルタリング

### パラメータ調整の推奨フロー

1. まずはデフォルト設定で実行
2. `analyze_report_detailed.py`で問題を特定
3. 改善提案に基づいてパラメータを調整
4. 再実行して改善を確認
5. 必要に応じて繰り返し

---

## トラブルシューティング

### 顔検出率が低い場合
- `MIN_FACE_SIZE`を小さくする（例: 25）
- `MIN_NEIGHBORS_FACE`を小さくする（例: 2）
- `REQUIRE_EYES`を`False`にする

### リジェクトが多い場合
- `MIN_FACE_AREA_RATIO`を小さくする（例: 0.05）
- 全身写真が多い場合は、この設定で調整

### 誤検出が多い場合
- `MIN_FACE_AREA_RATIO`を大きくする（例: 0.08）
- `REQUIRE_EYES`を`True`にする
- `MIN_EYES`を`2`にする（正面のみ）

### クロップに髪や背景が多すぎる場合
- `CROP_SCALE`を小さくする（例: 1.4）
- `CROP_ONLY_FOR_BC`を`True`にする（A_fullbodyを除外）

---

## ライセンス

このプロジェクトのライセンスについては、`LICENSE`ファイルを参照してください。
